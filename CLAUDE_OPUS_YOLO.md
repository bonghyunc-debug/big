# Claude Opus YOLO 미션: 양도소득세 신고서 작성 웹앱(로컬/데스크탑) 완성

## 0) 절대 규칙(질문 금지 / YOLO)
- 이 미션은 **질문 없이** 끝까지 진행한다.
- 불명확한 부분이 있으면:
  1) **국세청(nts.go.kr) 서식/안내**,
  2) **국가법령정보센터(law.go.kr) 현행법령(소득세법/시행령/시행규칙/조특법)**,
  3) **업로드된 별지 제84호 작성방법(PDF)**  
  을 순서대로 근거로 삼아 판단하고, 근거 링크를 `docs/spec/evidence_log.md`에 남긴다.
- 사용자의 홈택스 로그인/아이디/비밀번호를 요구하거나 자동화하지 않는다(금지).
- 앱은 **판정(요건 충족 여부)** 을 자동으로 결정하지 않는다. 대신:
  - 판정 입력을 위한 **선택 도우미(설명/툴팁/근거 팝오버)** 를 제공하고,
  - 사용자가 확정한 코드/체크에 따라 **계산/검증/출력** 을 수행한다.

---

## 1) 제품 목표(반드시 충족)
### 1.1 범위
- 대상: **거주자**, **2023년 이후 양도분**(양도일 기준)
- 지원: **별지 제84호 + 부표 1/2/2의2/3 + 해당 특례 서식(감면/특례 신청서)** 중 “양도소득세 신고서 출력”에 필요한 것
- 기능:
  - 스텝퍼 기반 입력(데스크탑 UI)
  - 다건 자산(복수 자산) 입력 + 합산신고(가/나 비교) 자동 계산
  - 세율/중과/단기보유 자동 적용(사용자 판정값 반영)
  - 고가주택(12억) 안분 및 장기보유특별공제 계산
  - 기한후/수정신고 가산세 및 감경률 계산
  - 부담부증여, 이월과세(필요경비 계산 특례) 지원
  - 부표 자동 연계(부표3 합계 → 부표1 취득가액/필요경비, 부표 합계 → 메인 집계)
  - 출력: **미리보기 → A4 단면 PDF 다운로드**
  - 첨부서류 체크리스트(자산유형/감면유형/특수규정별) 출력

### 1.2 제외
- 납부서/납부지 출력, 위택스 제출/전송, 홈택스 제출/전송, 파일 업로드(계약서 등) 일체 미지원
- 기준시가/환율/고시가액 자동 조회는 미지원(사용자 직접 입력).  
  단, 사용자가 요청한 예외만 구현:
  - **1990.8.29 이전 취득 토지의 취득시 기준시가 환산 보조**
  - **환산취득가액 계산(산식 기반)**

---

## 2) “완전 구현” 판정(커버리지 게이트) — 코드가 아닌 스펙+테스트로 판정
완전 구현의 정의는 아래 3가지 모두 만족:
1) **Field Catalog 100%**: `docs/spec/field_catalog.csv`에서 `Gate=Y`인 FieldID가
   - (a) UI 입력/표시,
   - (b) 저장,
   - (c) 출력 매핑  
   을 모두 갖추고 미구현이 0개.

2) **Rule Matrix 100%**: `docs/spec/rule_matrix.csv`에서 `Gate=Y`인 RuleID가
   - (a) 코드 구현(Implementation Map),
   - (b) 근거(Evidence),
   - (c) 테스트(TestID)
   를 모두 갖추고 미구현이 0개.

3) **Scenario 100%**: `docs/tests/SCENARIOS.md`의 “대표+경계값” 시나리오가
   - (a) 자동 테스트(계산) 통과,
   - (b) 수동 출력 체크(미리보기/다운로드) 체크리스트 통과.

게이트는 `npm run spec:check`로 자동 검증된다(이 repo에 포함된 스크립트 사용).

---

## 3) 구현 방식(스펙-구동형 개발)
### 3.1 스펙 파일(단일 진실)
- Field Catalog: `docs/spec/field_catalog.csv`
- Rule Matrix: `docs/spec/rule_matrix.csv`
- Enum Registry: `docs/spec/enum_registry.json`
- Evidence Log: `docs/spec/evidence_log.md`
- Implementation Map: `docs/spec/implementation_map.csv`

**원칙:**  
- “서식에 찍히는 모든 값(체크/코드/합계/서명/고지 포함)”은 Field로 등록한다.  
- 규칙은 CALC/VAL/OUT로 분리한다.  
- 모든 CALC/VAL 규칙은 최소 1개 근거 링크를 가진다.

### 3.2 룰팩(연도/시행일 분리)
- 세율/특례는 자주 바뀐다.  
- `src/rules/YYYY/` 아래에 **룰팩 JSON**으로 분리하고, `effectiveFrom/effectiveTo`로 적용기간을 관리한다.
- 하드코딩 금지(예외: 누진세율 기본표는 룰팩에 넣고 코드에서는 “테이블 엔진”만 유지).

---

## 4) UI/UX 요구(데스크탑 + 애플 톤)
- 스텝퍼(좌측 단계, 우측 폼)
- 한 화면 핵심 과업 1개, 여백 충분, 정렬선 일치
- 모든 입력은:
  - 라벨(짧게)
  - 툴팁(친절하지만 짧게)
  - 근거 팝오버(느낌표/물음표 아이콘) → 법령조문/국세청 안내 링크 표시
- 오류는 “무엇이 문제인지 + 해결방법”을 즉시 표시
- 접근성: 키보드 탭, 포커스 링, 대비

---

## 5) 기술 요구(권장 스택)
- Vite + React + TypeScript
- Zod: 입력 스키마/검증
- Zustand(또는 단순 React state) + IndexedDB(localforage)로 로컬 저장
- PDF: @react-pdf/renderer(또는 pdf-lib).  
  목표는 “서식 형식 유지”. 픽셀 단위 완전 일치가 아니라 **필드 배치/구성이 서식과 대응**하면 됨.
- 테스트: vitest (계산엔진), playwright(선택: 출력 미리보기 smoke)

---

## 6) 구현 순서(중요: 반드시 이 순서로 진행)
### Step 1. 근거/서식 다운로드 및 스냅샷 고정
1) 국세청 서식 다운로드 페이지에서 별지 제84호 및 부표 1/2/2의2/3, 관련 특례 서식을 모두 다운로드.
2) 다운로드한 파일의 버전(개정일)을 Evidence Log에 기록.
3) 국가법령정보센터에서 소득세법/시행령/시행규칙/조특법 관련 조문 링크를 Evidence Log에 기록.

### Step 2. Field Catalog 전수화(게이트 기반)
- 우선 Gate=Y 최소셋(메인+부표1/2/2의2/3 핵심 계산필드)부터 채운다.
- 이후 서식 페이지 단위로 Gate=N → Gate=Y 승격하며 전수화.

### Step 3. Rule Matrix 전수화(게이트 기반)
- 아래 “필수 룰팩”을 먼저 Gate=Y로 만든다.
  - 세율구분코드 → 세율/세율테이블
  - 단기보유 세율
  - 미등기 양도
  - 비사업용토지(가산)
  - 다주택 중과/한시배제
  - 고가주택(12억) 안분
  - 장특공(표1/표2 및 배제)
  - 환산취득가액
  - 기본공제(버킷/배분/미등기 제외)
  - 가/나 큰 금액 선택(감면 차감 후 비교)
  - 전자신고세액공제 2만원(초과공제 금지)
  - 가산세(무신고/과소/납부지연 + 감면)
  - 부담부증여 안분(유상양도 부분)
  - 이월과세(필요경비 계산 특례)

### Step 4. 계산 엔진 구현
- 입력(사용자 판정값 포함) → Derived(서식 필드) → Tax Engine(자산별/합산) → Output Mapping.
- 중간값(과세대상양도차익, 과세표준, 산출세액, 감면/공제, 가산세)을 모두 “설명 가능한 로그”로 남긴다(Privacy-safe).

### Step 5. 출력(서식/부표/체크리스트) 구현
- OUT 규칙대로 필요한 페이지만 PDF에 포함.
- 부표 자동연계는 FieldID 기반으로 구현.
- 출력물에는 “정보 제공 목적(자문 아님)” 고지 포함.

### Step 6. 테스트(시나리오 기반)
- 시나리오 JSON(입력 벡터) + 기대값(세액/중간값)으로 자동 테스트.
- 대표+경계값 세트:
  - 토지/건물/주택/분양권/조합원입주권/권리/기타자산/신탁/주식/파생
  - 단기(1년 미만, 1~2년), 미등기, 비사업용, 다주택 중과/배제, 고가주택, 장특공 표1/표2, 기한후/수정, 부담부증여, 이월과세
- `npm run spec:check` + `npm test` 를 통과해야 완료.

---

## 7) 산출물(완료 시 반드시 제출)
1) 실행 가능한 웹앱 코드(로컬 실행/빌드 가능)
2) `docs/spec/*` 완결본(필드/규칙/코드/근거/매핑)
3) `docs/tests/SCENARIOS.md` + `tests/scenarios/*.json` (대표 케이스 세트)
4) 출력 PDF 샘플 3개(부동산/주식/파생 대표)
5) 최종 ZIP 패키지(소스 + 문서 + 테스트 포함)

---

## 8) 자체 점검 체크리스트(반드시 통과)
- [ ] 개인정보/민감정보를 콘솔/로그에 출력하지 않는다
- [ ] 업로드 기능 없음
- [ ] 모든 계산 규칙은 Evidence 링크를 가진다
- [ ] RuleID ↔ 코드 ↔ 테스트가 1:1로 연결된다
- [ ] FieldID ↔ UI ↔ 저장 ↔ 출력이 1:1로 연결된다
- [ ] 출력 PDF는 A4 단면 기준, 페이지 구성 규칙 준수
- [ ] “판정은 사용자” 원칙 위반 없음(자동 판정 금지)

---

## 9) 보고 형식(작업 종료 시)
- 요약(3줄)
- 구현된 기능 목록(Feature Matrix 기준)
- 변경 파일 목록
- 실행 방법
- 테스트 결과
- 남은 리스크(법령/예외/미해결)

